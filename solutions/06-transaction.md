## この課題で身につく能力

トランザクションの必要性について説明できる

## 課題

今回の課題は全て口頭試問です。口頭試問を終えた **「後」** に自分が理解した内容をメモとしての残して提出して下さい。

1. 口頭試問: 「スッキリわかるSQL入門 第2版」p.301 問題9-1の空欄を埋めて下さい。採点者が問題に関わる知識を確認するために質問および説明をするので、それに答えて下さい。

解答) 空欄穴埋めの答えは書籍に載っているので省略します。

トランザクションの動作を理解するには実際に使ってみるの早いです。[01-dev-env.md](./01-dev-env.md)でインストールした`mysql 127.0.0.1 -u root -p`コマンドを使ってmysqlサーバーにログインしてみてください。その後

- `CREATE DATABASE test_transaction_db`
- `USE test_transaction_db`
- `CREATE TABLE ....`

と適当なテーブルを作成して、`BEGIN`, `COMMIT`を使ってトランザクションの動作を試してください。トランザクションの`BEGIN`を始めたタイミングで、もう1つのターミナル/コンソールから`mysql 127.0.0.1 -u root -p`に同じDBに対してログインして操作すると、トランザクションの実際の動作がよりわかりやすくなるでしょう。

以下の動画も合わせてみると、よりトランザクションの動作がわかりやすくなると思います。
- [Database Transactions, part 2: Examples](https://www.youtube.com/watch?v=PguCDI_fi3U)

---
2. 口頭試問: 「スッキリわかるSQL入門 第2版」p.301 問題9-2の解答を確認して下さい。READ COMMITEDに関わる話は無視して構いません。採点者が問題に関わる知識を確認するために質問および説明をするので、それに答えて下さい。

解答) 空欄穴埋めの答えは書籍に載っているので省略します。

２つ以上のテーブルに対して「同時に」INSERT/UPDATE/DELETEする場合、トランザクションが必要ということを理解してください。
図で表すと問題9-2のシステムはこのような感じです。

![Image from iOS (40)](https://user-images.githubusercontent.com/7414320/77185025-04119300-6b14-11ea-9dc6-44ff38181995.jpg)

「受注と在庫が不一致なテーブルを発生させるなんて、そんな雑なシステムを実際のビジネスで作るやつおらんやろ」と思うかもしれませんが、います。いました。
https://blog.tokumaru.org/2015/05/blog-post.html
> 部屋数２０３室の仙台市のビジネスホテルで、９月１８～２３日の宿泊予約を数千件受け付けるトラブルがあった。アイドルグループ「嵐」のライブが宮城県内で開催される期間だった。インターネットでの申し込みが殺到し、システム障害が起きたとみられるという。

それに「不整合なDBテーブル更新は発生しない」システムを作ったとしても、DBに不整合がないだけで「ロールバックが頻繁に発生する」「更新待ち時間が異常に長い」システムになることがあります。
トランザクションは奥が深いので、今は「奥が深いものだ」「システム全体のパフォーマンスに影響を及ぼすものだ」ということを頭の片隅に入れておきましょう。

READ COMITTEDの話は無視していいと言いましたが、どうしても理解したい場合はMySQLのドキュメントなどを読むと良いと思います。ハッキリ言って難しいです。聞かれればリチャードの知っている限りの説明をします。難しいですが面白いですよ。
https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html

また、トランザクションの実装は各データベース・ソフトウェア依存なのでMySQLとPostgresとOracleとMS SQLとで全部微妙に違っていたりします…かもしれません。リチャードも各ソフトウェアの違いをよく把握していないです。

---

3. 口頭試問: 「スッキリわかるSQL入門 第2版」p.301 問題9-3の解答を確認して下さい。ア～エまでで十分です、オ以降は無視して構いません。採点者が問題に関わる知識を確認するために質問および説明をするので、それに答えて下さい。

解答) ◯✕の答えは書籍に載っているので省略します。ア～エまで解説を読んでちゃんと理解できるように、知らない単語など調べてください。わからなかったら採点者や同僚に質問してください。